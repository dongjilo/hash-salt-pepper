<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Register</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
</head>

<body class="min-h-screen bg-gray-100 flex items-center justify-center p-4">
  <div class="max-w-md w-full bg-white rounded-xl shadow-lg p-8">
    <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">Create account</h2>

    <form id="registerForm" method="post" action="/register" class="space-y-4" novalidate>
      <div>
        <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
        <input
          id="username"
          name="username"
          type="text"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all"
          placeholder="Choose a username"
          required
        />
        <div id="usernameHelp" class="text-sm text-gray-600 mt-2">Allowed: letters, numbers, underscores. Min 3 characters.</div>
        <div id="sanitizedPreviewWrap" class="text-sm mt-2 text-gray-600" style="display:none">
          Will be stored as: <strong id="sanitizedPreview"></strong>
        </div>
        <div id="availabilityWrap" class="text-sm mt-1" style="display:none">
          <span id="availability" class="font-medium"></span>
        </div>
      </div>

      <div>
        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
        <input
          id="password"
          name="password"
          type="password"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all"
          placeholder="Create a password"
          autocomplete="new-password"
          required
        />
      </div>

      <div>
        <label for="confirm" class="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label>
        <input
          id="confirm"
          name="confirm"
          type="password"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all"
          placeholder="Repeat your password"
          autocomplete="new-password"
          required
        />
        <span id="matchIndicator" class="text-sm block mt-2" style="display:none"></span>
      </div>

      <!-- Password strength bar -->
      <div id="strengthSection" class="mt-3 mb-2" style="display:none">
        <div id="strengthBar" class="w-full h-3 bg-gray-300 rounded overflow-hidden">
          <div id="strengthFill" style="width:0;height:100%;transition:width .25s; background:#ef4444;"></div>
        </div>
        <span id="strengthText" class="text-gray-500">Strength: </span>
      </div>

      <!-- Password rules checklist -->
      <ul id="pwRules" class="mb-2 mt-2 text-sm" style="display:none">
        <li id="lengthRule">❌ At least 12 characters</li>
        <li id="uppercaseRule">❌ At least one uppercase letter</li>
        <li id="lowercaseRule">❌ At least one lowercase letter</li>
        <li id="digitRule">❌ At least one digit</li>
        <li id="specialRule">❌ At least one special symbol</li>
      </ul>

      <button id="registerBtn" type="submit" disabled
        class="w-full bg-gray-300 text-gray-600 font-medium py-2.5 rounded-lg transition-colors cursor-not-allowed">
        Register
      </button>
    </form>

    {% if error %}
      <!-- only show non-password-rule errors because client enforces password rules -->
      {% if error != "Password must be at least 12 characters and include uppercase, lowercase, digit, and symbol." %}
        <p class="mt-4 text-red-500" role="alert">{{ error }}</p>
      {% endif %}
    {% endif %}

    <div class="mt-6 text-center text-sm text-gray-600">
      Already have an account?
      <a href="/login" class="text-indigo-600 hover:text-indigo-500 font-medium">Sign in</a>
    </div>
  </div>

  <script>
    // ---------------- Username sanitization & validation ----------------
    const usernameInput = document.getElementById('username');
    const sanitizedPreviewWrap = document.getElementById('sanitizedPreviewWrap');
    const sanitizedPreview = document.getElementById('sanitizedPreview');
    const availabilityWrap = document.getElementById('availabilityWrap');
    const availabilitySpan = document.getElementById('availability');

    function sanitizeClientUsername(raw) {
      if (!raw) return '';
      let s = raw.trim();
      s = s.replace(/\s+/g, '_');           // collapse whitespace => underscores
      s = s.replace(/[^A-Za-z0-9_]/g, '');  // remove invalid chars
      if (s.length > 30) s = s.slice(0, 30); // truncate to 30
      return s;
    }

    function isUsernameValid(cleaned) {
      return /^[A-Za-z0-9_]{3,30}$/.test(cleaned);
    }

    // debounce helper
    function debounce(fn, ms) {
      let t;
      return function(...args) {
        clearTimeout(t);
        t = setTimeout(() => fn.apply(this, args), ms);
      };
    }

    // call availability API
    async function checkAvailability(clean) {
      if (!clean) return { available: false, reason: 'invalid', clean: '' };
      try {
        const resp = await fetch(`/api/username-available?q=${encodeURIComponent(clean)}`, { cache: 'no-store' });
        if (!resp.ok) {
          return { available: false, reason: 'error', clean };
        }
        return await resp.json();
      } catch (err) {
        return { available: false, reason: 'error', clean };
      }
    }

    // update availability UI based on API result
    function setAvailabilityUI(result) {
      availabilityWrap.style.display = 'block';
      if (result.reason === 'invalid') {
        availabilitySpan.textContent = 'Invalid username';
        availabilitySpan.className = 'text-red-600';
        usernameValid = false;
      } else if (result.reason === 'taken') {
        availabilitySpan.textContent = `${result.clean} is already taken`;
        availabilitySpan.className = 'text-red-600';
        usernameValid = false;
      } else if (result.reason === 'ok' && result.available) {
        availabilitySpan.textContent = `${result.clean} is available`;
        availabilitySpan.className = 'text-green-600';
        usernameValid = true;
      } else {
        availabilitySpan.textContent = 'Unable to check availability right now';
        availabilitySpan.className = 'text-yellow-600';
        usernameValid = false;
      }
      updateRegisterButton();
    }

    // debounced wrapper for availability checks
    const debouncedCheck = debounce(async (raw) => {
      const cleaned = sanitizeClientUsername(raw);
      if (!cleaned) {
        sanitizedPreviewWrap.style.display = 'none';
        sanitizedPreview.textContent = '';
        availabilityWrap.style.display = 'none';
        usernameValid = false;
        updateRegisterButton();
        return;
      }
      sanitizedPreviewWrap.style.display = 'block';
      sanitizedPreview.textContent = cleaned;

      // Only call API if sanitized username is syntactically valid
      if (!isUsernameValid(cleaned)) {
        setAvailabilityUI({ available: false, reason: 'invalid', clean: cleaned });
        return;
      }

      // show checking state
      availabilityWrap.style.display = 'block';
      availabilitySpan.textContent = 'Checking availability…';
      availabilitySpan.className = 'text-gray-600';

      const result = await checkAvailability(cleaned);
      setAvailabilityUI(result);
    }, 400); // 400ms debounce

    // ---------------- Password UI & rules ----------------
    const password = document.getElementById('password');
    const confirm = document.getElementById('confirm');
    const matchIndicator = document.getElementById('matchIndicator');
    const pwRules = {
      length: document.getElementById('lengthRule'),
      uppercase: document.getElementById('uppercaseRule'),
      lowercase: document.getElementById('lowercaseRule'),
      digit: document.getElementById('digitRule'),
      special: document.getElementById('specialRule')
    };
    const pwRulesList = document.getElementById('pwRules');
    const strengthSection = document.getElementById('strengthSection');
    const strengthBarFill = document.getElementById('strengthFill');
    const strengthText = document.getElementById('strengthText');
    const registerBtn = document.getElementById('registerBtn');
    const registerForm = document.getElementById('registerForm');

    let allRulesMet = false;
    let passwordsMatch = false;
    let usernameValid = false;

    function checkPasswordStrength(pw) {
      let score = 0;
      if (pw.length >= 12) {
        score++; pwRules.length.textContent = "✅ At least 12 characters"; pwRules.length.className = "text-green-600";
      } else {
        pwRules.length.textContent = "❌ At least 12 characters"; pwRules.length.className = "text-red-600";
      }
      if (/[A-Z]/.test(pw)) {
        score++; pwRules.uppercase.textContent = "✅ At least one uppercase letter"; pwRules.uppercase.className = "text-green-600";
      } else {
        pwRules.uppercase.textContent = "❌ At least one uppercase letter"; pwRules.uppercase.className = "text-red-600";
      }
      if (/[a-z]/.test(pw)) {
        score++; pwRules.lowercase.textContent = "✅ At least one lowercase letter"; pwRules.lowercase.className = "text-green-600";
      } else {
        pwRules.lowercase.textContent = "❌ At least one lowercase letter"; pwRules.lowercase.className = "text-red-600";
      }
      if (/\d/.test(pw)) {
        score++; pwRules.digit.textContent = "✅ At least one digit"; pwRules.digit.className = "text-green-600";
      } else {
        pwRules.digit.textContent = "❌ At least one digit"; pwRules.digit.className = "text-red-600";
      }
      if (/[^A-Za-z0-9]/.test(pw)) {
        score++; pwRules.special.textContent = "✅ At least one special symbol"; pwRules.special.className = "text-green-600";
      } else {
        pwRules.special.textContent = "❌ At least one special symbol"; pwRules.special.className = "text-red-600";
      }

      // Strength meter visuals
      if (score <= 2) {
        strengthBarFill.style.width = '30%';
        strengthBarFill.style.background = '#ef4444';
        strengthText.textContent = 'Strength: Weak';
        strengthText.className = 'text-red-600';
      } else if (score === 3 || score === 4) {
        strengthBarFill.style.width = '65%';
        strengthBarFill.style.background = '#f59e0b';
        strengthText.textContent = 'Strength: Medium';
        strengthText.className = 'text-yellow-600';
      } else if (score === 5) {
        strengthBarFill.style.width = '100%';
        strengthBarFill.style.background = '#10b981';
        strengthText.textContent = 'Strength: Strong';
        strengthText.className = 'text-green-600';
      } else {
        strengthBarFill.style.width = '0%';
      }

      allRulesMet = (score === 5);
    }

    function checkMatch() {
      if (password.value && confirm.value) {
        matchIndicator.style.display = "block";
        if (password.value === confirm.value) {
          matchIndicator.textContent = "✅ Passwords match";
          matchIndicator.className = "text-green-600";
          passwordsMatch = true;
        } else {
          matchIndicator.textContent = "❌ Passwords do not match";
          matchIndicator.className = "text-red-600";
          passwordsMatch = false;
        }
      } else {
        matchIndicator.textContent = "";
        matchIndicator.style.display = "none";
        passwordsMatch = false;
      }
    }

    function showValidation() {
      if (password.value.length > 0) {
        pwRulesList.style.display = "block";
        strengthSection.style.display = "block";
      } else {
        pwRulesList.style.display = "none";
        strengthSection.style.display = "none";
        matchIndicator.style.display = "none";
      }
    }

    function updateRegisterButton() {
      const canEnable = usernameValid && allRulesMet && passwordsMatch;
      if (canEnable) {
        registerBtn.disabled = false;
        registerBtn.classList.remove('bg-gray-300', 'text-gray-600', 'cursor-not-allowed');
        registerBtn.classList.add('bg-indigo-600', 'text-white');
      } else {
        registerBtn.disabled = true;
        registerBtn.classList.remove('bg-indigo-600', 'text-white');
        registerBtn.classList.add('bg-gray-300', 'text-gray-600', 'cursor-not-allowed');
      }
    }

    // ---------------- Event wiring ----------------
    usernameInput.addEventListener('input', (e) => {
      debouncedCheck(e.target.value);
    });

    // Optional: replace input on blur with cleaned value
    usernameInput.addEventListener('blur', () => {
      usernameInput.value = sanitizeClientUsername(usernameInput.value);
    });

    if (password && confirm) {
      password.addEventListener('input', () => {
        showValidation();
        checkPasswordStrength(password.value);
        checkMatch();
        updateRegisterButton();
      });
      confirm.addEventListener('input', () => {
        checkMatch();
        updateRegisterButton();
      });

      registerForm.addEventListener('submit', function (e) {
        if (!(usernameValid && allRulesMet && passwordsMatch)) {
          e.preventDefault();
        }
      });
    }

    // Initial state
    showValidation();
    checkPasswordStrength('');
    checkMatch();
    usernameInput.dispatchEvent(new Event('input'));
    updateRegisterButton();
  </script>
</body>

</html>
